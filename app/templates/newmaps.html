
{% extends "base.html" %}
//working with zip codes
<!-- Map -->
  {% block content %}
<div class="large-centered 
                  large-10 medium-centered medium-8 small-8 small-centered
                  columns">
  <script type="text/javascript">
    var map;
    $(document).ready(function(){
      map = new GMaps({     // create a new map
        el: 'map',
        lat: 39.9500,
        lng: -75.1667
      });
      var markers = [];      // array of markers to be displayed on the map
            $.getJSON($SCRIPT_ROOT + '/_newmap',  
            // Pull all food resources in database to be displayed when the page is initially loaded.
            function(data) {
              for (var i = 0; i < data["resources"].length; i++) {
                var newAddress = data["resources"][i]["address"]["line1"] + ', ' 
                  + data["resources"][i]["address"]["city"] + ', ' 
                  + data["resources"][i]["address"]["state"] ;

                (function() {
                    var newTitle = data["resources"][i]["name"];
                    var newDescription = newTitle + "<br>" 
                      + data["resources"][i]["description"] + "<br>" 
                      + "Contact Information: " 
                      + data["resources"][i]["phone_number"]["number"];      
                    var newType = 
                      data["resources"][i]["food_resource_type"]["enum"];
                    var filename = 
                      data["resources"][i]["food_resource_type"]["colored_pin"]["pin_image_name"];
                    var image = "../static/img/" + filename; 
                GMaps.geocode({
                  address: newAddress,
                  callback: function(results, status) {
                    if (status == 'OK')
                    {
                      var newMarker = results[0].geometry.location; 
                      var addressInfo = results[0].formatted_address;
                      var removedCommas = addressInfo.split(",").join("");
                      var linkInfo = removedCommas.split(" ").join("+");
                      var completeLink = "https://maps.google.com?daddr=" + linkInfo; 
                      // Create link to be displayed on Google Maps for directions to the food resource.
                      markers.push({
                        lat : newMarker.lat(),
                        lng : newMarker.lng(),
                        title: newTitle,
                        icon : { url: image,
                                size: new google.maps.Size(50,50),
                                scaledSize: new google.maps.Size(20,25)},
                        click: function(e) { 
                          // Create description and directions below map when marker is clicked.
                          document.getElementById("marker-info").innerHTML = "Information About This Food Resource: <br>" + newDescription + "<br>";
                          $('.linkInsert').attr('href',completeLink);
                        }
                      }); 
                    }
                    map.addMarkers(markers);     //adds all markers to map  
                    map.fitZoom();              //and fits map window to show all of them
                  }
                  }); }) ();
              }
           });

      $('#geocoding_form').submit(function(e){
        map.removeMarkers();
        e.preventDefault();

        GMaps.geocode({
          address: $('#address').val().trim(),
          callback: function(results, status) {
            if (status == 'OK') {

              /* Add address marker to center of map. */
              var marker = results[0].geometry.location;
              var markerImage = "../static/img/mbb_black.png";
              map.addMarker({
                lat : marker.lat(),
                lng : marker.lng(),
                title: "Current Address",
                icon : { url: markerImage,
                  size: new google.maps.Size(50,50),
                  scaledSize: new google.maps.Size(20,25) }
              });

              /* Center the map at the given zip code or address. */
              map.setCenter(marker.lat(), marker.lng());

              /* Save searched zip code in database. */
              var zipCode = ""; 
              for (var i = 0; i < results[0].address_components.length; i++) {
                if (results[0].address_components[i].types[0] == "postal_code") {
                  zipCode = results[0].address_components[i].short_name;
                }
              }
              var json_data = {
                zipCode: zipCode
              };  
              $.post(url = $SCRIPT_ROOT + '/_search_query', data = json_data);

              // Populate map with food resources from database.
              $.getJSON($SCRIPT_ROOT + '/_map', {
                zip_code: zipCode
              },
              function(data) {
                for (var i = 0; i < data["addresses"].length; i++) {
                  var newAddress = data["addresses"][i]["address"]["line1"] + ', ' 
                    + data["addresses"][i]["address"]["city"] + ', ' 
                    + data["addresses"][i]["address"]["state"] ;
                    (function() {
                      var newTitle = data["addresses"][i]["name"];
                      var newDescription = newTitle + "<br>" 
                        + data["addresses"][i]["description"] + "<br>" 
                        + "Contact Information: " 
                        + data["addresses"][i]["phone_number"]["number"];        
                      var newType = 
                        data["addresses"][i]["food_resource_type"]["enum"];
                      var filename = 
                        data["addresses"][i]["food_resource_type"]["colored_pin"]["pin_image_name"];
                      var image = "../static/img/" + filename; 
                      GMaps.geocode({
                        address: newAddress,
                        callback: function(results, status) {
                          if (status == 'OK') {
                            var newMarker = results[0].geometry.location; 
                            myLat = newMarker.lat();
                            myLng = newMarker.lng();

                            /* Change the format of the address to generate a Google Maps link with directions. */
                            var addressInfo = results[0].formatted_address;  
                            var removedCommas = addressInfo.replace(/,/g, "");
                            var linkInfo = removedCommas.replace(/ /g, "+");
                            var completeLink = "https://maps.google.com?daddr=" + linkInfo; 

                            /* Add each marker to map. */                     
                            map.addMarker({
                              lat : newMarker.lat(),
                              lng : newMarker.lng(),
                              title: newTitle,
                              icon : { url: image,
                                      size: new google.maps.Size(50,50),
                                      scaledSize: new google.maps.Size(20,25) },
                              click: function(e) {
                                document.getElementById("marker-info").innerHTML = "Information About This Food Resource: <br>" + newDescription + "<br><br>";
                                $('.linkInsert').attr('href',completeLink);
                              }
                            }); 
                          }
                          map.fitZoom();  
                        }
                      }); 
                    }()); // Call anonymous function.
                  }
                });
              }
            }
          });
        });  
      })                              
    </script>
</div>

<body id = "map_p">
    <div class="row">
        <h1 class="page-header" id="map-header">Philly Food Finder</h1>
        <hr align="center">
    </div>

    <!-- Editable content box for "Announcements" --> 
    <div class="row">
        <div class="large-centered 
                  large-10 medium-centered medium-8 small-8 small-centered
                  columns content">
            <div id="editor1" contenteditable="false">
                {{ html_string.value|safe }}
            </div>
        </div>
    </div>
    {% if current_user.is_authenticated() %}
    <div class="row"> 
      <div class="large-centered large-10 medium-centered medium-8 small-8 small-centered columns content">
        <div class="button radius tiny start-edit">Edit</div>
        <div class="button radius tiny end-edit" id="map-announcements">Save</div> 
      </div> 
    </div>
    {% endif %}

    <!-- Map filtering -->
    <div class="row">
        <div class="large-centered large-10 medium-centered medium-10 small-10 small-centered columns content">
            <form method="post" id="geocoding_form">
                <div class="small-12 columns">
                    <label for="address">Zip Code:</label>
                    <input type="text" id="address" name="address" />
                </div>
                <div class="small-12 columns">
                  <ul id="checkboxes">
                    {% for boolean in food_resource_booleans %}
                    <li class="checkbox-li">            
                      <input type="checkbox" id="filter-by-boolean-{{ boolean.hyphenated_id }}"/> {{ boolean.description_question }}
                    </li>
                    {% endfor %}
                  </ul>
                </div>                                            
                <div class="small-12 columns">
                    <input type="submit" class="button radius small" value="Search" id="map-search-button" />
                    <input type="submit" class="button radius small" value="Clear Filters" id="map-filter-button" />
                </div>
                <div class="row">
                    <div class="small-12 columns" id="map-search-error">
                    </div>
                </div>
            </form>      
            <div id="map-container">
                <div class="large-4" id="map"></div>
            </div> 

            <!-- Information about the selected pin -->
            <div id="marker-info">Click on a pin for more information!<br></div>
            <div id="directions-link">
              <p>
                <a class="linkInsert" href="http://www.maps.google.com" target="_blank">Get directions to the selected pin!</a>
              </p>
            </div>

            <!-- Map legend: Pin images with associated food resource types --> 
            <div id="map-key">
                <div class="small-6 medium-4 columns pin-definition">
                    <img src="../static/img/mbb_black.png" alt="Black Pin"/>
                    Searched Location
                </div>

                {% for food_resource_type in food_resource_types %}
                <div class="small-6 medium-4 columns pin-definition">
                    <img src="../static/img/{{ food_resource_type.colored_pin.pin_image_name }}" alt="{{ food_resource_type.colored_pin.color_name}} Pin"/>
                    {{ food_resource_type.name_singular }}
                </div>
                {% endfor %}
            </div>
            <div id="footer-spacer">
            </div>
        </div>
    </div> 
</body>

{% if current_user.is_authenticated() %}
<script>
    $(".end-edit").hide();
</script>
{% endif %}

{% endblock %}
